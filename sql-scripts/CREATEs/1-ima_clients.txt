CREATE TABLE ima_clients (

	client_id INT AUTO_INCREMENT PRIMARY KEY,
	client_type ENUM ('Personal', 'Business') NOT NULL,
	
	first_name VARCHAR (100),
	middle_name VARCHAR (100),
	last_name VARCHAR (100),
	
	date_of_birth DATE,
	
	legal_business_name VARCHAR (255),
	dba_name VARCHAR (255),
	business_structure ENUM (
		'Sole Proprietorship', 'Partnership', 'LLC',
		'Corporation', 'S-Corp', 'C-Corp', 'Non-Profit',
		'Other'
	),
	ein VARCHAR (100),
	date_established DATE,
	years_in_business TINYINT,
	id_type ENUM (
		'PAN',
		'Aadhaar',
		'Driving License',
		'Passport',
		'Voter ID',
		'SSN',
		'EIN',
		'GSTIN',
		'CIN',
		'Other'
	) NOT NULL,

	id_number VARCHAR (50) NOT NULL,

	id_issue_country CHAR (2) DEFAULT 'IN',
	id_expiry_date DATE,

	physical_address_line1 VARCHAR (255) NOT NULL,
	physical_address_line2 VARCHAR (255),
	physical_city VARCHAR (100) NOT NULL,
	physical_state VARCHAR (100),
	physical_zip_code VARCHAR (100),
	physical_country CHAR (2) DEFAULT 'IN',

	mailing_same_as_physical BOOLEAN DEFAULT TRUE,

	mailing_address_line1 VARCHAR(255),
	mailing_address_line2 VARCHAR(255),
	mailing_city VARCHAR(100),
	mailing_state VARCHAR(100),
	mailing_zip_code VARCHAR(100),
	mailing_country CHAR(2) DEFAULT 'IN',

	business_description TEXT,
	sic_code CHAR (4),
	naics_code CHAR (6),

	annual_gross_revenue DECIMAL (15, 2) DEFAULT 0,
	annual_payroll DECIMAL (15, 2) DEFAULT 0,

	employees_full_time INT DEFAULT 0,
	employees_part_time INT DEFAULT 0,
	employees_seasonal INT DEFAULT 0,

	ownership_details JSON,

	primary_contact_name VARCHAR (100) NOT NULL,
	primary_contact_phone VARCHAR (20),
	primary_contact_email VARCHAR (255),

	application_date DATETIME DEFAULT CURRENT_TIMESTAMP,

	status ENUM ('Pending', 'Under Review', 'Approved', 'Declined', 'Issued') DEFAULT 'Pending',

	INDEX idx_id (id_type, id_number),
	INDEX idx_name (first_name, last_name, legal_business_name),
	INDEX idx_email (primary_contact_email),
	INDEX idx_physical_country (physical_country),
	INDEX idx_mailing_country (mailing_country),
	INDEX idx_client_type (client_type),

	CONSTRAINT chk_personal_fields
		CHECK (
			(
				client_type = 'Personal' AND first_name IS NOT NULL AND last_name IS NOT NULL AND date_of_birth IS NOT NULL AND legal_business_name IS NULL AND ein IS NULL
			)
			OR
			(client_type = 'Business')
		),

	CONSTRAINT chk_business_fields
		CHECK (
			(
				client_type = 'Business' AND legal_business_name IS NOT NULL AND date_established IS NOT NULL AND first_name IS NULL AND last_name IS NULL
			)
			OR
			(client_type = 'Personal')	
		),

	CONSTRAINT chk_id_format
CHECK (
    (id_type = 'PAN' AND id_number REGEXP '^[A-Z]{5}[0-9]{4}[A-Z]{1}$')
    OR
    (id_type = 'Aadhaar' AND id_number REGEXP '^[0-9]{4}$|^XXXX-XXXX-[0-9]{4}$')
    OR
    (id_type = 'GSTIN' AND id_number REGEXP '^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$') 
    OR
    (id_type = 'SSN' AND id_number REGEXP '^[0-9]{3}-[0-9]{2}-[0-9]{4}$')
    OR
    (id_type = 'EIN' AND id_number REGEXP '^[0-9]{2}-[0-9]{7}$')
    OR
    (id_type IN ('Passport', 'Driving License', 'Voter ID', 'CIN', 'Other') AND id_number != '')
),

	CONSTRAINT chk_financials
		CHECK (
			(client_type = 'Personal' AND 
             annual_gross_revenue = 0 AND 
             annual_payroll = 0 AND
             employees_full_time = 0 AND 
             employees_part_time = 0 AND 
             employees_seasonal = 0) OR (client_type = 'Business')
		)


);





DELIMITER $$

CREATE TRIGGER set_years_in_business
BEFORE INSERT ON ima_clients
FOR EACH ROW
BEGIN
  IF NEW.client_type = 'Business' AND NEW.date_established IS NOT NULL THEN
    SET NEW.years_in_business = 
      YEAR(CURRENT_DATE) - YEAR(NEW.date_established) -
      (DATE_FORMAT(CURRENT_DATE, '%m%d') < DATE_FORMAT(NEW.date_established, '%m%d'));
  ELSE
    SET NEW.years_in_business = NULL;
  END IF;
END$$

DELIMITER ;
