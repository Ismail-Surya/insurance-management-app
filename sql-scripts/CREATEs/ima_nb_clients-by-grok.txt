CREATE TABLE clients (
    client_id INT AUTO_INCREMENT PRIMARY KEY,
    
    -- Client Type: Personal or Business
    client_type ENUM('Personal', 'Business') NOT NULL,
    
    -- === PERSONAL CLIENT FIELDS ===
    first_name VARCHAR(100),
    middle_name VARCHAR(100),
    last_name VARCHAR(100),
    date_of_birth DATE, -- For personal only
    ssn VARCHAR(11), -- XXX-XX-XXXX (personal only)
    
    -- === BUSINESS CLIENT FIELDS ===
    legal_business_name VARCHAR(255),
    dba_name VARCHAR(255),
    business_structure ENUM(
        'Sole Proprietorship', 'Partnership', 'LLC', 
        'Corporation', 'S-Corp', 'C-Corp', 'Non-Profit', 'Other'
    ),
    ein VARCHAR(10), -- XX-XXXXXXX (business only)
    date_established DATE, -- Business only
    years_in_business TINYINT GENERATED ALWAYS AS (
        IF(client_type = 'Business' AND date_established IS NOT NULL,
           YEAR(CURDATE()) - YEAR(date_established) - 
           (DATE_FORMAT(CURDATE(), '%m%d') < DATE_FORMAT(date_established, '%m%d')),
           NULL)
    ) STORED,
    
    -- === SHARED TAX ID (UNIQUE ACROSS ALL) ===
    tax_id VARCHAR(12) NOT NULL, -- SSN or EIN in standard format
    tax_id_type ENUM('SSN', 'EIN') NOT NULL,
    
    -- === ADDRESS (Shared) ===
    address_line1 VARCHAR(255) NOT NULL,
    address_line2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state CHAR(2) NOT NULL,
    zip_code VARCHAR(10) NOT NULL,
    country CHAR(2) DEFAULT 'US',
    
    -- Mailing address same as physical? Use app logic or add separate fields if needed
    
    -- === BUSINESS OPERATIONS (Business only) ===
    business_description TEXT,
    sic_code CHAR(4),
    naics_code CHAR(6),
    
    -- === FINANCIAL (Business only) ===
    annual_gross_revenue DECIMAL(15,2) DEFAULT 0,
    annual_payroll DECIMAL(15,2) DEFAULT 0,
    
    -- === EMPLOYEES (Business only) ===
    employees_full_time INT DEFAULT 0,
    employees_part_time INT DEFAULT 0,
    employees_seasonal INT DEFAULT 0,
    
    -- === OWNERSHIP (Business only) - JSON for multiple owners ===
    ownership_details JSON,
    -- e.g., [{"name": "John Doe", "title": "Owner", "ownership_percent": 100}]
    
    -- === PRIOR INSURANCE (Both) - JSON for flexibility ===
    prior_insurance_history JSON,
    -- e.g., [{"carrier": "...", "policy_num": "...", "exp_date": "...", "premium": ..., "claims": [...]}]
    
    -- === CONTACT INFO (Both) ===
    primary_contact_name VARCHAR(100) NOT NULL,
    primary_contact_phone VARCHAR(20),
    primary_contact_email VARCHAR(255),
    
    -- === SYSTEM FIELDS ===
    application_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Pending', 'Under Review', 'Approved', 'Declined', 'Issued') DEFAULT 'Pending',
    
    -- === INDEXES ===
    INDEX idx_client_type (client_type),
    INDEX idx_tax_id (tax_id),
    INDEX idx_name (last_name, legal_business_name),
    INDEX idx_email (primary_contact_email),
    INDEX idx_naics (naics_code),
    INDEX idx_status (status),
    
    -- === CONSTRAINTS ===
    CONSTRAINT chk_personal_required 
        CHECK (
            (client_type = 'Personal' AND 
             first_name IS NOT NULL AND 
             last_name IS NOT NULL AND 
             date_of_birth IS NOT NULL AND 
             ssn IS NOT NULL AND
             ein IS NULL AND 
             legal_business_name IS NULL)
            OR
            (client_type = 'Business')
        ),
        
    CONSTRAINT chk_business_required 
        CHECK (
            (client_type = 'Business' AND 
             legal_business_name IS NOT NULL AND 
             ein IS NOT NULL AND 
             date_established IS NOT NULL AND
             first_name IS NULL AND 
             last_name IS NULL AND 
             ssn IS NULL)
            OR
            (client_type = 'Personal')
        ),
        
    CONSTRAINT chk_revenue_payroll 
        CHECK (
            (client_type = 'Personal' AND annual_gross_revenue = 0 AND annual_payroll = 0)
            OR
            (client_type = 'Business' AND annual_gross_revenue >= 0 AND annual_payroll >= 0)
        ),
        
    CONSTRAINT chk_employee_counts 
        CHECK (
            (client_type = 'Personal' AND 
             employees_full_time = 0 AND 
             employees_part_time = 0 AND 
             employees_seasonal = 0)
            OR
            (client_type = 'Business' AND 
             employees_full_time >= 0 AND 
             employees_part_time >= 0 AND 
             employees_seasonal >= 0)
        ),
        
    CONSTRAINT chk_tax_id_format 
        CHECK (
            (tax_id_type = 'SSN' AND tax_id REGEXP '^[0-9]{3}-[0-9]{2}-[0-9]{4}$')
            OR
            (tax_id_type = 'EIN' AND tax_id REGEXP '^[0-9]{2}-[0-9]{7}$')
        )
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;







CREATE TABLE clients (
    client_id INT AUTO_INCREMENT PRIMARY KEY,
    
    -- Client Type
    client_type ENUM('Personal', 'Business') NOT NULL,
    
    -- === PERSONAL FIELDS ===
    first_name VARCHAR(100),
    middle_name VARCHAR(100),
    last_name VARCHAR(100),
    date_of_birth DATE,
    
    -- === BUSINESS FIELDS ===
    legal_business_name VARCHAR(255),
    dba_name VARCHAR(255),
    business_structure ENUM(
        'Sole Proprietorship', 'Partnership', 'LLC', 
        'Corporation', 'S-Corp', 'C-Corp', 'Non-Profit', 'Other'
    ),
    date_established DATE,
    years_in_business TINYINT GENERATED ALWAYS AS (
        IF(client_type = 'Business' AND date_established IS NOT NULL,
           YEAR(CURDATE()) - YEAR(date_established) - 
           (DATE_FORMAT(CURDATE(), '%m%d') < DATE_FORMAT(date_established, '%m%d')),
           NULL)
    ) STORED,
    
    -- === FLEXIBLE ID SYSTEM (Replaces SSN/EIN) ===
    id_type ENUM(
        'PAN',           -- India
        'Aadhaar',       -- India (last 4 digits only for privacy)
        'Driving_License',
        'Passport',
        'Voter_ID',      -- India
        'SSN',           -- USA
        'EIN',           -- USA Business
        'GSTIN',         -- India Business
        'CIN',           -- India Corporate Identity Number
        'Other'
    ) NOT NULL,
    
    id_number VARCHAR(50) NOT NULL,  -- Flexible length
    id_issue_country CHAR(2) DEFAULT 'IN',  -- ISO country code
    id_expiry_date DATE,  -- Optional, for DL/Passport
    
    -- === ADDRESS (Shared) ===
    address_line1 VARCHAR(255) NOT NULL,
    address_line2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100),  -- Full state name or code
    zip_code VARCHAR(15),
    country CHAR(2) DEFAULT 'IN',
    
    -- === BUSINESS OPERATIONS ===
    business_description TEXT,
    sic_code CHAR(4),
    naics_code CHAR(6),
    
    -- === FINANCIALS (Business only) ===
    annual_gross_revenue DECIMAL(15,2) DEFAULT 0,
    annual_payroll DECIMAL(15,2) DEFAULT 0,
    
    -- === EMPLOYEES ===
    employees_full_time INT DEFAULT 0,
    employees_part_time INT DEFAULT 0,
    employees_seasonal INT DEFAULT 0,
    
    -- === OWNERSHIP (JSON) ===
    ownership_details JSON,
    
    -- === PRIOR INSURANCE (JSON) ===
    prior_insurance_history JSON,
    
    -- === CONTACT ===
    primary_contact_name VARCHAR(100) NOT NULL,
    primary_contact_phone VARCHAR(20),
    primary_contact_email VARCHAR(255),
    
    -- === SYSTEM ===
    application_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Pending', 'Under Review', 'Approved', 'Declined', 'Issued') DEFAULT 'Pending',
    
    -- === INDEXES ===
    INDEX idx_id (id_type, id_number),
    INDEX idx_name (first_name, last_name, legal_business_name),
    INDEX idx_email (primary_contact_email),
    INDEX idx_country (country),
    INDEX idx_client_type (client_type),
    
    -- === VALIDATION CONSTRAINTS ===
    
    -- Personal: Name + DOB required; business fields NULL
    CONSTRAINT chk_personal_fields
        CHECK (
            (client_type = 'Personal' AND 
             first_name IS NOT NULL AND 
             last_name IS NOT NULL AND 
             date_of_birth IS NOT NULL AND
             legal_business_name IS NULL AND
             ein IS NULL)
            OR (client_type = 'Business')
        ),
    
    -- Business: Legal name + establishment date required
    CONSTRAINT chk_business_fields
        CHECK (
            (client_type = 'Business' AND 
             legal_business_name IS NOT NULL AND 
             date_established IS NOT NULL AND
             first_name IS NULL AND 
             last_name IS NULL)
            OR (client_type = 'Personal')
        ),
    
    -- ID Format Validation (Basic Regex)
    CONSTRAINT chk_id_format
        CHECK (
            -- PAN: 5 letters + 4 digits + 1 letter
            (id_type = 'PAN' AND id_number REGEXP '^[A-Z]{5}[0-9]{4}[A-Z]{1}$') OR
            
            -- Aadhaar: Accept last 4 digits only (privacy-safe) OR full masked
            (id_type = 'Aadhaar' AND id_number REGEXP '^[0-9]{4}$|^XXXX-XXXX-[0-9]{4}$') OR
            
            -- GSTIN: 15 chars, state code + PAN + check digit
            (id_type = 'GSTIN' AND id_number REGEXP '^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$') OR
            
            -- SSN: XXX-XX-XXXX
            (id_type = 'SSN' AND id_number REGEXP '^[0-9]{3}-[0-9]{2}-[0-9]{4}$') OR
            
            -- EIN: XX-XXXXXXX
            (id_type = 'EIN' AND id_number REGEXP '^[0-9]{2}-[0-9]{7}$') OR
            
            -- Passport / DL / Others: Accept any non-empty
            (id_type IN ('Passport', 'Driving_License', 'Voter_ID', 'CIN', 'Other') AND id_number != '')
        ),
    
    -- Employee & Revenue: Zero for Personal
    CONSTRAINT chk_financials
        CHECK (
            (client_type = 'Personal' AND 
             annual_gross_revenue = 0 AND 
             annual_payroll = 0 AND
             employees_full_time = 0 AND 
             employees_part_time = 0 AND 
             employees_seasonal = 0)
            OR
            (client_type = 'Business')
        )
    
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;